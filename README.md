
# Graph Schema Diff Tool

## Overview

`graph-schema-diff` is a service that compares two GraphQL schemas and identifies any breaking changes between them. The tool generates a structured JSON output and also creates a natural language summary suitable for release notes. The release notes are ideal for notifying users about API changes, ensuring smooth version upgrades for GraphQL services.

## Features

- Detects breaking and non-breaking changes between two GraphQL schemas.
- Outputs structured JSON format with details of changes.
- Provides a natural language summary of changes for API release notes.
- Easily integratable into release pipelines to automate change detection and notification.

## Structured JSON Example

Here’s an example of the output generated by the tool:

```json
{
  "changes": [
    {
      "type": "Query",
      "field": "getWeather",
      "change": "Renamed input parameter 'location' to 'city'",
      "breaking": true,
      "release_note": "The input parameter for `getWeather` has been renamed from `location` to `city`. This is a breaking change, so make sure to update any queries that use `location` to `city`."
    },
    {
      "type": "Weather",
      "field": "visibility",
      "change": "Added new scalar field 'visibility'",
      "breaking": false,
      "release_note": "We've added a new `visibility` field to the `Weather` type. You can now get visibility information in your weather queries without modifying existing ones. This is a non-breaking change."
    }
  ],
  "release_notes": {
    "summary": "This release introduces a breaking change with the renaming of the `location` parameter to `city` in the `getWeather` query, and a non-breaking enhancement with the addition of a new `visibility` field in the `Weather` type."
  }
}
```

## Sample Schemas

Below is an example of an initial and updated schema:

### Initial Schema (Version 1)

```graphql
type Query {
  getWeather(location: String!): Weather
}

type Weather {
  temperature: Float
  description: String
  humidity: Int
  windSpeed: Float
}
```

### Updated Schema (Version 2)

```graphql
type Query {
  getWeather(city: String!): Weather
}

type Weather {
  temperature: Float
  description: String
  humidity: Int
  windSpeed: Float
  visibility: Int
}
```

## Usage

The `graph-schema-diff` service can be integrated into release pipelines for GraphQL services. It compares the current and updated GraphQL schemas to automatically detect and communicate changes to API consumers.

This tool can be extended to support other API specifications such as REST, Swagger/OpenAPI, gRPC, and SOAP.


## Repository outline

```bash
.
├── README.md                      # Project documentation.
├── data                           # Contains test case directories with GraphQL schemas and expected results.
│   ├── test1
│   ├── test2
│   ├── test3
│   └── test4
├── design                         # Additional design resources and example outputs.
├── graph_schema_diff              # Core application logic including the GraphQL comparator and API.
│   ├── app.py                     # Flask app exposing GraphQL comparator as a REST API.
│   ├── graphql_comparator.py       # Main logic for comparing GraphQL schemas.
│   └── test                       # Unit tests for the GraphQL comparator.
├── models                         # Directory for model files and scripts.
│   ├── download-models.sh         # Script to download required models.
│   └── mixtral-8x7b-instruct-v0.1.Q4_K_M.gguf  # Language model used in the comparator.
├── requirements.txt               # Python dependencies required for the project.
├── scripts                        # Helper scripts for interacting with the API and monitoring resources.
└── setup.py                       # Setup file for Python package installation.
```

## Installation & Setup

1. Clone the repository:
   ```bash
   git clone <repository-url>
   cd graph-schema-diff
   ```

2. Run the setup.sh script
   ```bash
   source scripts/setup.sh
   ```

3. Run the example code for graphql_comparator.py
   ```bash
   python graph_schema_diff/graphql_comparator.py
   ```

4. Run the graph_schema_diff service
   ```bash
   python graph_schema_diff/app.py
   ```

5. Test query examples can be found in the scripts directory:
   ```bash
    ./scripts/get_model_info.sh
    ./scripts/post_compare_request.sh data/test1/schema1.graphql data/test1/schema2.graphql
    ./scripts/get_statistics.sh
    ./scripts/get_apidocs.sh
    ```

## Testing

Unit tests have been implemted using pytest and can be executed using the command below.

   ```bash
   pytest graph_schema_diff/test/test_graphql_comparator.py
   ```

These tests can take some time to complete, it is possible to specify a single test by following the example below.

   ```bash
   pytest graph_schema_diff/test/test_graphql_comparator.py::test_compare_test1
   ```

## References

1. [LlamaCpp Model](https://github.com/ggerganov/llama.cpp)
2. [Guidance AI on GitHub](https://github.com/guidance-ai/guidance)
3. [Guidance Documentation](https://guidance.readthedocs.io/en/latest/index.html)
